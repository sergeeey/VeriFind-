name: Golden Set Validation

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/golden_set/**'
      - 'tests/integration/test_golden_set_integration.py'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  golden-set-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-json-report

      - name: Run Golden Set with Real API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          pytest tests/integration/test_golden_set_integration.py \
            -m realapi \
            -v \
            --tb=short \
            --json-report \
            --json-report-file=golden-set-report.json \
            --json-report-indent=2

      - name: Check Golden Set Thresholds
        id: threshold_check
        run: |
          python scripts/check_golden_set_thresholds.py golden-set-report.json
        continue-on-error: true

      - name: Upload Golden Set Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-set-report
          path: |
            golden-set-report.json
            golden-set-summary.md
          retention-days: 30

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read report
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync('golden-set-report.json', 'utf8'));
            } catch (error) {
              console.error('Failed to read report:', error);
              return;
            }

            // Read summary
            let summary = '';
            try {
              summary = fs.readFileSync('golden-set-summary.md', 'utf8');
            } catch (error) {
              summary = '‚ö†Ô∏è Summary not generated';
            }

            // Create comment body
            const body = `## üß™ Golden Set Validation Results

            ${summary}

            ### üìä Test Statistics
            - **Total Tests:** ${report.summary?.total || 0}
            - **Passed:** ${report.summary?.passed || 0}
            - **Failed:** ${report.summary?.failed || 0}
            - **Duration:** ${(report.duration || 0).toFixed(2)}s

            ### üéØ Quality Metrics
            ${report.metrics ? `
            - **Accuracy:** ${(report.metrics.accuracy * 100).toFixed(2)}% ${report.metrics.accuracy >= 0.9 ? '‚úÖ' : '‚ùå'}
            - **Hallucination Rate:** ${(report.metrics.hallucination_rate * 100).toFixed(2)}% ${report.metrics.hallucination_rate === 0 ? '‚úÖ' : '‚ùå'}
            - **Temporal Violations:** ${report.metrics.temporal_violations} ${report.metrics.temporal_violations === 0 ? '‚úÖ' : '‚ùå'}
            ` : '_Metrics not available_'}

            ### üìù Details
            <details>
            <summary>View full report</summary>

            \`\`\`json
            ${JSON.stringify(report, null, 2).substring(0, 5000)}
            \`\`\`
            </details>

            ---
            _Generated by Golden Set CI/CD ‚Ä¢ [View Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})_
            `;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if Thresholds Not Met
        if: steps.threshold_check.outcome == 'failure'
        run: |
          echo "‚ùå Golden Set validation failed quality thresholds"
          echo "See golden-set-summary.md for details"
          exit 1

      - name: Success Summary
        if: steps.threshold_check.outcome == 'success'
        run: |
          echo "‚úÖ Golden Set validation passed all quality thresholds"
          cat golden-set-summary.md
